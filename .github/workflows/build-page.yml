name: Build and Deploy Pages

on:
  workflow_run:
    workflows: ["Update lists"]
    types:
      - completed

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
        contents: read
        pages: write
        id-token: write

    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 1

    - name: Checkout lists branch
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        ref: lists
        path: lists
        fetch-depth: 1

    - name: Generate database
      run: |
        DB_FILENAME="site/rules-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}.db.pgp" # the file is not actually encrypted, this prevents GitHub Pages from compressing it
        python3 site/create_db.py "lists/lists" "$DB_FILENAME"

    - name: Upload github pages artifact
      uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
      with:
        path: site/

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
